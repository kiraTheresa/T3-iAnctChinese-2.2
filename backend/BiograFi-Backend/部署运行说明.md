# BiograFi-Backend 部署运行说明

## 1. 项目概述

BiograFi-Backend是一个基于Spring Boot 3.x的传记标注系统后端服务，提供用户管理、项目管理、文档管理、实体标注、可视化分析、导出、AI服务和分词服务等功能。

### 1.1 新增功能

- **AI服务**：文本分析、问答系统、自动标注
- **分词服务**：中文文本分词，返回每个词的起止位置

## 2. 环境要求

| 环境类型 | 必需组件 | 可选组件 |
|---------|---------|---------|
| 开发环境 | JDK 17+、Maven 3.8+ | Git |
| 生产环境 | JDK 17+、Maven 3.8+、MySQL 8.0+ | Nginx、Docker |

## 3. 配置文件说明

项目使用多种配置方式，包括YAML配置文件和环境变量配置文件：

- **application.yaml**：公共配置，包含应用基本信息、服务器配置、文件上传配置等
- **application-dev.yaml**：开发环境配置，使用H2内存数据库
- **application-prod.yaml**：生产环境配置，使用MySQL数据库
- **.env**：环境变量配置文件，用于存储敏感信息，如API Key等

### 3.1 配置优先级

Spring Boot将按照以下顺序加载配置：

1. 命令行参数
2. 系统环境变量
3. .env文件中的环境变量
4. application-{profile}.yaml（环境特定配置）
5. application.yaml（公共配置）

### 3.2 AI服务配置

AI服务需要配置DeepSeek API Key，可以通过以下方式配置：

#### 3.2.1 使用.env文件配置

1. 在项目根目录下创建或编辑.env文件：

```bash
# DeepSeek API 配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here

# 可选配置项
# DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
# DEEPSEEK_MODEL=deepseek-chat
# TEMPERATURE=0.75
# MAX_TOKENS=2000
# TOP_P=0.9
# TIMEOUT=60
```

2. 将`your_deepseek_api_key_here`替换为您的实际DeepSeek API Key

#### 3.2.2 使用系统环境变量配置

```bash
# Linux/Mac
export DEEPSEEK_API_KEY=your_deepseek_api_key_here

# Windows
set DEEPSEEK_API_KEY=your_deepseek_api_key_here
```

#### 3.2.3 使用命令行参数配置

```bash
java -jar -DDEEPSEEK_API_KEY=your_deepseek_api_key_here target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
```

## 4. 开发环境部署

### 4.1 环境准备

1. 确保已安装JDK 17+和Maven 3.8+
2. 验证安装：
   ```bash
   java -version
   mvn -version
   ```

### 4.2 项目构建

```bash
# 克隆项目
git clone <repository-url>
cd BiograFi-Backend

# 构建项目（跳过测试）
mvn clean install -DskipTests
```

### 4.3 运行项目

#### 4.3.1 使用Maven直接运行

```bash
mvn spring-boot:run
```

#### 4.3.2 使用jar包运行

```bash
java -jar target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
```

#### 4.3.3 指定环境运行

```bash
java -jar -Dspring.profiles.active=dev target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
```

### 4.4 开发环境特性

- 使用H2内存数据库，无需额外配置
- 自动创建数据库表结构（ddl-auto: update）
- H2控制台可访问：http://localhost:5002/h2-console
- 详细日志输出，便于开发调试

## 5. 生产环境部署

### 5.1 环境准备

1. 安装JDK 17+和Maven 3.8+
2. 安装并配置MySQL 8.0+数据库

### 5.2 数据库配置

#### 5.2.1 创建数据库

```sql
-- 创建数据库
CREATE DATABASE biografi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户并授权
CREATE USER 'biografi'@'%' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON biografi.* TO 'biografi'@'%';
FLUSH PRIVILEGES;
```

#### 5.2.2 配置数据库连接

修改 `application-prod.yaml` 文件中的数据库连接信息：

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://your-mysql-host:3306/biografi?useUnicode=true&characterEncoding=utf-8&serverTimezone=UTC
    username: biografi
    password: your_secure_password
```

### 5.3 项目构建

```bash
# 克隆项目
git clone <repository-url>
cd BiograFi-Backend

# 构建生产环境jar包
mvn clean package -DskipTests
```

### 5.4 运行项目

#### 5.4.1 直接运行jar包

```bash
# 生产环境运行
java -jar -Dspring.profiles.active=prod target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
```

#### 5.4.2 使用nohup后台运行

```bash
# 后台运行并输出日志到文件
nohup java -jar -Dspring.profiles.active=prod target/BiograFi-Backend-0.0.1-SNAPSHOT.jar > biografi.log 2>&1 &

# 查看进程
ps -ef | grep BiograFi-Backend

# 查看日志
tail -f biografi.log
```

#### 5.4.3 使用systemd管理服务

1. 创建systemd服务文件 `/etc/systemd/system/biografi-backend.service`：

```ini
[Unit]
Description=BiograFi-Backend Service
After=syslog.target network.target

[Service]
Type=simple
User=nobody
Group=nobody
WorkingDirectory=/path/to/BiograFi-Backend
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

2. 启用并启动服务：

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable biografi-backend.service

# 启动服务
sudo systemctl start biografi-backend.service

# 查看服务状态
sudo systemctl status biografi-backend.service

# 查看日志
sudo journalctl -u biografi-backend.service -f
```

### 5.5 生产环境特性

- 使用MySQL数据库，数据持久化存储
- 数据库表结构验证模式（ddl-auto: validate）
- 精简日志输出，提高性能
- 支持多种部署方式，适合生产环境

## 6. 服务验证

### 6.1 健康检查

项目提供了健康检查端点，可用于监控服务状态：

```bash
curl http://localhost:5002/api/health
```

正常返回：
```json
{"status":"UP"}
```

### 6.2 API文档访问

- Swagger UI：http://localhost:5002/swagger-ui.html
- API文档JSON：http://localhost:5002/v3/api-docs

### 6.3 测试账号

开发和生产环境默认提供测试账号：

```
用户名：admin
密码：admin123
```

## 7. 常见问题排查

### 7.1 端口被占用

**问题**：启动时提示端口被占用

**解决方案**：
1. 查看端口占用情况：
   ```bash
   # Linux/Mac
   lsof -i :5002
   
   # Windows
   netstat -ano | findstr :5002
   ```

2. 停止占用端口的进程或修改配置文件中的端口：
   ```yaml
   server:
     port: 8080  # 修改为其他可用端口
   ```

### 7.2 数据库连接失败

**问题**：无法连接到数据库

**解决方案**：
1. 验证数据库服务是否正常运行
2. 检查数据库连接配置是否正确（URL、用户名、密码）
3. 确保数据库用户有足够的权限
4. 检查网络连接是否正常

### 7.3 Maven依赖下载失败

**问题**：构建时依赖下载失败

**解决方案**：
1. 清理Maven本地仓库：
   ```bash
   mvn dependency:purge-local-repository
   ```

2. 强制更新依赖：
   ```bash
   mvn clean install -U -DskipTests
   ```

3. 检查网络连接或配置国内镜像源

### 7.4 服务启动缓慢

**问题**：服务启动时间过长

**解决方案**：
1. 检查数据库连接是否正常
2. 优化JVM参数：
   ```bash
   java -Xms512m -Xmx2g -jar target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
   ```

3. 检查系统资源使用情况

## 8. 性能优化建议

### 8.1 JVM参数优化

```bash
java -Xms1g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar target/BiograFi-Backend-0.0.1-SNAPSHOT.jar
```

### 8.2 数据库优化

1. 定期备份数据库
2. 优化数据库查询性能
3. 考虑使用连接池（已内置HikariCP）

### 8.3 服务优化

1. 考虑使用Nginx作为反向代理
2. 配置SSL证书，启用HTTPS
3. 考虑集群部署，提高可用性
4. 使用监控工具（如Prometheus + Grafana）监控服务状态

## 9. 部署架构建议

### 9.1 基础架构

```
客户端 → Nginx（反向代理） → BiograFi-Backend → MySQL
```

### 9.2 集群架构

```
客户端 → Nginx（负载均衡） → BiograFi-Backend 集群 → MySQL 主从复制
```

## 10. 版本更新指南

### 10.1 备份数据

```bash
# 备份MySQL数据库
mysqldump -u root -p biografi > biografi_backup_$(date +%Y%m%d).sql
```

### 10.2 更新项目

```bash
# 拉取最新代码
git pull origin main

# 构建项目
mvn clean install -DskipTests

# 停止旧服务
# 启动新服务
```

### 10.3 数据迁移

如果数据库结构有变更，需要执行数据迁移脚本：

```bash
# 使用Flyway或Liquibase等工具执行迁移
```

## 11. 技术支持

如遇到问题，可通过以下方式获取支持：

- 查看项目日志文件
- 查阅API文档
- 提交Issue到项目仓库
- 联系开发团队

## 12. 附录

### 12.1 主要配置项说明

| 配置项 | 说明 | 默认值 | 环境 |
|-------|------|-------|------|
| spring.application.name | 应用名称 | BiograFi-Backend | 公共 |
| spring.profiles.active | 激活环境 | dev | 公共 |
| server.port | 服务端口 | 5002 | 公共 |
| spring.datasource.* | 数据库连接配置 | - | 环境特定 |
| spring.jpa.hibernate.ddl-auto | 数据库表结构策略 | update/dev, validate/prod | 环境特定 |
| spring.servlet.multipart.* | 文件上传配置 | max-file-size: 50MB | 公共 |
| logging.level.* | 日志级别配置 | - | 环境特定 |

### 12.2 常用命令汇总

| 操作 | 命令 |
|-----|-----|
| 构建项目 | mvn clean install -DskipTests |
| 运行开发环境 | mvn spring-boot:run |
| 运行生产环境 | java -jar -Dspring.profiles.active=prod target/BiograFi-Backend-0.0.1-SNAPSHOT.jar |
| 查看日志 | tail -f biografi.log |
| 健康检查 | curl http://localhost:5002/api/health |
| 停止服务 | kill <pid> 或 sudo systemctl stop biografi-backend.service |